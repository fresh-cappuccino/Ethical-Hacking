#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
# 3 - dns3.py3 - SLIDES

"""
  Esse arquivo faz a enumeração
  dos servidores DNS com lista

  Modificado em 31 de outubro de 2018
  por Vitor Mazuco (contato@vmzsolutions.com.br)

"""

from queue import Queue
import threading, socket

dominio = "dominio.com"
lock = threading.Lock() #1 Mostra de forma organizada

def forca_bruta():
    while not q.empty(): #2 Checa se o objeto 'Queue' está vazio
        DNS = q.get() + "." + dominio #3 Será feito a leitura em forma de fila - do menor para o maior, ex: 1,2,3...
        try: #4 Um bloco de tentativa de execução, com exceções a serem usados 
            IP = socket.gethostbyname(DNS) #5 Obtem o IP do servidores DNS
            lock.acquire() #6 Espera ele ficar desocupado
            print(DNS + ":\t" + IP) #7 Printar de forma organizada
        except socket.gaierror: #8 Gera um erro, caso ocorra
            pass #9 Passa adiante 
        else: #10 Senão
            lock.release() #11 O lock irá ser liberado
        q.task_done() #12 Mostra ao Queue foi liberado com sucesso

q = Queue() #13 Criação do objeto 
 
for i in range(20): # 14
    t = threading.Thread(target=forca_bruta)
    t.daemon = True
    t.start()

with open("lista.txt") as lista: #15
    while True: #16
        nome = lista.readline().strip("\n") #17
        if not nome:
            break #18
        q.put(nome) #19

q.join() #20
print("\nMapeamento completo")
